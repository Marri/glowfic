- attrs = {}
- gallery_klass = []
- if local_assigns[:character_gallery]
  - gallery_klass << 'section-ordered'
  - attrs[:data] = {id: character_gallery.id, order: character_gallery.section_order}
- gallery_klass << "gallery-title-#{gallery.id}" if gallery
%tbody{class: gallery_klass, **attrs}
  %tr.gallery-header
    %th.gallery-table-title{class: (klass if defined? klass)}
      - link = gallery ? gallery_path(gallery) : user_gallery_path(id: 0, user_id: @user.id)
      = link_to gallery ? gallery.name : 'Galleryless icons', link, class: 'gallery-title'
      - if is_owner && !skip_forms
        = link_to add_gallery_path(gallery || {id: 0}), class: 'gallery-add' do
          .link-box.action-new + Add Icons
        - if gallery
          = link_to edit_gallery_path(gallery), class: 'gallery-edit' do
            .link-box.action-edit
              = image_tag "icons/pencil.png"
              Edit Gallery
          = link_to gallery_path(gallery), method: :delete, data: { confirm: 'Are you sure you want to delete this gallery? (This will not delete the icons.)' }, class: 'gallery-delete' do
            .link-box.action-delete x Delete Gallery
      - unless local_assigns[:hide_minmax]
        .gallery-box.float-right.gallery-minmax{data: {id: gallery.id}} -
      - if local_assigns[:character_gallery] && (is_owner || current_user.try(:admin?))
        .float-right
          = image_tag "icons/arrow_up.png", class: "section-up disabled-arrow"
          = image_tag "icons/arrow_down.png", class: "section-down disabled-arrow"
%tbody{class: ("gallery-data-#{gallery.id}" if gallery)}
  - groups = gallery.gallery_groups_data if gallery
  - if groups.present?
    %tr.gallery-tags
      %th.subber{id: "gallery-tags-#{gallery.id}"}
        Groups:
        .tag-box
          - groups.each do |group|
            = link_to tag_path(group.id), class: 'tag-item-link' do
              %span.tag-item
                = group.name
  - if !gallery && is_owner
    %tr.gallery-subheader
      %th.sub Unsorted icons without a gallery will appear here. They can still be individually assigned to a character with no galleries.
  - icons ||= gallery ? gallery.icons : @user.galleryless_icons
  %tr.gallery-icons
    %td.icons-box
      .gallery{id: "gallery#{gallery ? gallery.id : 0}"}
        = form_tag delete_multiple_icons_path, method: :delete do
          - icons.pluck(:id, :keyword, :url).each do |icon_id, keyword, url|
            .gallery-icon
              = link_to icon_path(id: icon_id) do
                = icon_mem_tag url, keyword
                %br
                %span.icon-keyword= keyword
              - if is_owner && !skip_forms
                .select-button= check_box_tag :"marked_ids[]", icon_id, false, id: nil
          - if icons.empty?
            .centered.no-icons — No icons yet —
          - elsif is_owner && !skip_forms
            .clear.centered.icons-remove
              - if gallery
                = hidden_field_tag :gallery_id, gallery.id
                = submit_tag "- Remove selected icons from gallery", name: 'gallery_delete'
              = submit_tag "x Delete selected icons permanently", data: { confirm: "Are you sure? These icons will be gone from the site!" }
